---
layout: default
title: アルゴリズム実装
lang: ja
---

# アルゴリズム実装

## 概要

このドキュメントでは、ピザ分割アプリケーションで**実際に使用されている**3つのコア機能における技術的手法とアルゴリズムを、エンジニア向けにわかりやすく解説します。

## 重要な注意事項

このドキュメントは、フロントエンドから実際に呼び出されている以下の3つのAPIエンドポイントの実装のみを解説しています：

- `/api/pizza-cutter/divide` - ピザ分割処理
- `/api/pizza-cutter/score` - 分割評価スコア
- `/api/face/emotion` - 感情分析による請求書分割

---

## 1. ピザ分割アルゴリズム
### API: `/api/pizza-cutter/divide`

### 技術的チャレンジ

ピザの総面積とサラミ分布の両方を全てのピースで等しくする公平な分割をどのように実現するか？

### 解決手法: 移動ナイフ法 + モンテカルロ

#### 1. 前処理パイプライン

**楕円→円 正規化変換:**
- カメラ角度により楕円形に写ったピザを正確な円形に補正
- アフィン変換により長軸・短軸比を1:1に正規化
- 後続のアルゴリズムで円形前提の計算を可能にする

#### 2. AI画像解析

**ピザ領域検出:**
- **YOLOv8セグメンテーション**: `yolov8n-seg.pt`モデルでピザ領域を検出
- **最小外接円**: OpenCVの`minEnclosingCircle`でピザ境界を円近似
- **中心座標正規化**: ピザ中心を原点、半径を1.0に正規化

**サラミ検出:**
- **YOLOv11モデル**: カスタム`weights.pt`でサラミ領域をセグメンテーション
- **距離変換**: `cv2.distanceTransform`で各サラミの中心を検出
- **円形度フィルタ**: 閾値0.3で非円形ノイズを除去、最小半径12px

#### 3. 移動ナイフ法実装

**モンテカルロ点生成:**
- 単位円内に50,000点を一様ランダム分布で生成
- 各点に重み `w = π/50,000` を付与（面積近似用）
- ピザ内点とサラミ内点を別々に管理

**目標値計算:**
```
A_goal = π / n  (各ピースの目標ピザ面積)
B_goal = 総サラミ面積 / n  (各ピースの目標サラミ面積)
```

**角度最適化:**
- 0.5°刻みのグリッド探索で最適切断角度を決定
- 各角度でピザ面積 = A_goal となる切断線を計算
- サラミ面積がB_goalに最も近い角度を選択

#### 4. グリーディピース割り当て

**アルゴリズム:**
1. 角度順に切断線を決定
2. 残存領域内でモンテカルロ点をピースに割り当て
3. 目標面積に達したピースを確定
4. 残りの点で次のピースを処理

**収束条件:**
- 全ピースの面積が目標値±5%以内
- 最大25回の反復で処理完了

### 技術的なポイント

**計算効率:**
- モンテカルロ法により複雑な積分計算を単純化
- O(N × M)の計算量（N=点数、M=角度グリッド数）
- 並列処理によるYOLOモデルの最適化

**精度保証:**
- 50,000点サンプリングで±1%の面積精度
- 0.5°角度分解能で実用十分な切断精度

---

## 2. 公平性評価スコアリング
### API: `/api/pizza-cutter/score`

### 技術的チャレンジ

実際のピザ分割と理想的な分割の公平性をどのように定量的に評価するか？

### 解決手法: 指数減衰スコアリング

#### 1. 画像分析

**分割後ピース検出:**
- 同じYOLOv8 + YOLOv11パイプラインで各ピースを分析
- `cv2.connectedComponents`で連結成分解析
- 各ピースのピザ面積とサラミ面積を計算

#### 2. 統計的公平性評価

**標準偏差ベース評価:**
```
ピザ標準偏差 = std(各ピースのピザ面積比)
サラミ標準偏差 = std(各ピースのサラミ面積比)
```

**指数減衰スコア計算:**
```
ピザスコア = 100 × exp(-2.0 × ピザ標準偏差 / 0.10)
サラミスコア = 100 × exp(-2.0 × サラミ標準偏差 / 0.05)
```

#### 3. 重み付き総合評価

**重み配分:**
- ピザ面積: 重み1.0
- サラミ分布: 重み5.0（サラミ分布を5倍重視）

**最終スコア:**
```
総合スコア = (1.0 × ピザスコア + 5.0 × サラミスコア) / 6.0
```

### 技術的なポイント

**スコア解釈:**
- 100点: 完全に均等な分割
- 80-90点: 実用的に公平な分割
- 60-80点: やや不均等だが許容範囲
- 60点未満: 明らかに不公平な分割

**基準値の意味:**
- ピザ基準値0.10 = 10%の面積ばらつきで37点
- サラミ基準値0.05 = 5%の分布ばらつきで37点

---

## 3. 感情分析による請求書分割
### API: `/api/face/emotion`

### 技術的チャレンジ

満足度を示す表情から公平な請求書分割をどのように自動計算するか？

### 解決手法: 顔検出 + 感情認識 + 支払い確率

#### 1. 顔検出アルゴリズム

**OpenCV Haar Cascade:**
- `haarcascade_frontalface_default.xml`を使用
- 検出パラメータ: スケール係数1.1、最小近傍4、最小サイズ50×50px
- グレースケール変換で検出精度向上
- 検出した顔を200×200pxにリサイズ

#### 2. 感情認識エンジン

**FER + MTCNN:**
- FERライブラリの事前訓練済みCNNモデル
- MTCNN=Trueで顔検出精度を向上
- 7つの感情クラス: angry, disgust, fear, happy, sad, surprise, neutral
- 各感情の信頼度スコア（0-1）を出力

#### 3. 支払い確率計算

**感情重み マッピング:**
```
happy: 0.90     (幸せな人ほど多く支払う)
surprise: 0.80  (驚いている人も比較的多く支払う)
neutral: 0.05   (無表情は最低限の支払い)
fear: 0.20      (不安な人は少なく支払う)
sad: 0.20       (悲しい人は少なく支払う)
angry: 0.15     (怒っている人はより少なく支払う)
disgust: 0.15   (嫌悪感のある人はより少なく支払う)
```

**支払い比率計算:**
```
個人支払い確率 = Σ(感情スコア × 感情重み)
正規化支払い比率 = 個人支払い確率 / 全員の支払い確率合計
```

### 技術的なポイント

**ロバスト性:**
- 顔検出失敗時はプレースホルダー処理
- 感情認識失敗時は中立感情として扱い
- 最小近傍4で誤検出を削減

**公平性考慮:**
- 極端な支払い比率を避けるための正規化
- 全員が最低限の支払いを負担する設計

---

## 全体システム統合

### 処理フロー

1. **画像アップロード**: フロントエンドからBase64エンコード画像を受信
2. **並列AI処理**: YOLOv8（ピザ）とYOLOv11（サラミ）を並列実行
3. **座標正規化**: 検出結果を正規化座標系に変換
4. **アルゴリズム実行**: 移動ナイフ法またはスコアリング実行
5. **結果可視化**: SVG形式での切断線生成、PNG形式でのオーバーレイ画像

### パフォーマンス特性

**計算量:**
- ピザ分割: O(50,000 × 角度グリッド数) ≈ O(10⁶)
- スコアリング: O(画像ピクセル数) ≈ O(10⁶)
- 感情分析: O(検出顔数 × CNN推論時間)

**応答時間:**
- ピザ分割: 3-8秒（画像サイズ・ピース数依存）
- スコアリング: 1-3秒
- 感情分析: 2-5秒（顔数依存）

---

## まとめ

このピザ分割アプリケーションは、3つの実装済みコア機能により、公平なピザ分割から請求書計算まで一貫したユーザー体験を提供します。各アルゴリズムは実用性と計算効率のバランスを重視し、Webアプリケーションとして現実的な応答時間で動作するよう最適化されています。

**実装の特徴:**

1. **実用重視**: 理論的完璧性より実用的な公平性を追求
2. **計算効率**: モンテカルロ法による近似で実時間処理を実現
3. **ロバスト性**: AI失敗時のフォールバック処理で安定動作
4. **ユーザビリティ**: 複雑なアルゴリズムの直感的な結果表示